<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Saúde Plena — Navegação Territorial</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body{height:100%;margin:0}
#map{height:100vh;width:100vw}

#info{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:#0f172a;
  color:#fff;
  padding:8px 16px;
  border-radius:999px;
  font-size:14px;
  z-index:1000;
  box-shadow:0 6px 20px rgba(0,0,0,.35)
}

#voltar{
  position:absolute;
  top:10px;
  left:10px;
  background:#111827;
  color:#fff;
  border:none;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  z-index:1000;
  display:none;
}
</style>
</head>

<body>

<button id="voltar">⬅ Voltar</button>
<div id="info">Passe o mouse • Clique para entrar</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ================= MAPA ================= */
const map = L.map("map").setView([-14,-54],4);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"© OpenStreetMap"
}).addTo(map);

/* ================= VARIÁVEIS ================= */
let nivel = "regiao";
let camadaAtual;
let geoRegioes, geoEstados, geoMunicipios;
let pilha = [];

const info = document.getElementById("info");
const voltar = document.getElementById("voltar");

/* ================= ESTILO ================= */
function estilo(cor){
  return {weight:1.3,color:cor,fillColor:cor,fillOpacity:.25};
}

/* ================= FEATURE ================= */
function bindFeature(layer, nome){
  layer.bindTooltip(nome,{sticky:true});
  layer.on("mouseover",e=>e.target.setStyle({weight:3,fillOpacity:.4}));
  layer.on("mouseout",()=>camadaAtual.resetStyle(layer));
}

/* ================= MOSTRAR ================= */
function limpar(){
  if(camadaAtual) map.removeLayer(camadaAtual);
}

function mostrarRegioes(){
  limpar();
  camadaAtual = L.geoJSON(geoRegioes,{
    style:()=>estilo("#7c3aed"),
    onEachFeature:(f,l)=>{
      const nome = f.properties.NM_REGIAO || f.properties.nome || "Região";
      bindFeature(l,nome);
      l.on("click",()=>{
        pilha=[];
        pilha.push(mostrarRegioes);
        mostrarEstados(nome);
      });
    }
  }).addTo(map);

  nivel="regiao";
  voltar.style.display="none";
  info.innerText="Brasil • Regiões";
  map.setView([-14,-54],4);
}

function mostrarEstados(regiao){
  limpar();
  camadaAtual = L.geoJSON(geoEstados,{
    style:()=>estilo("#2563eb"),
    filter:f => f.properties.NM_REGIAO === regiao,
    onEachFeature:(f,l)=>{
      const nome = f.properties.NM_UF;
      bindFeature(l,nome);
      l.on("click",()=>{
        pilha.push(()=>mostrarEstados(regiao));
        mostrarMunicipios(f.properties.SIGLA_UF);
      });
    }
  }).addTo(map);

  nivel="estado";
  voltar.style.display="block";
  info.innerText=`Região: ${regiao}`;
  map.fitBounds(camadaAtual.getBounds());
}

function mostrarMunicipios(uf){
  limpar();
  camadaAtual = L.geoJSON(geoMunicipios,{
    style:()=>estilo("#059669"),
    filter:f => f.properties.SIGLA_UF === uf,
    onEachFeature:(f,l)=>{
      const nome = f.properties.NM_MUN;
      bindFeature(l,nome);
    }
  }).addTo(map);

  nivel="municipio";
  info.innerText=`Estado: ${uf}`;
  map.fitBounds(camadaAtual.getBounds());
}

/* ================= LOAD ================= */
async function iniciar(){
  geoRegioes = await fetch("data/regioes.geojson").then(r=>r.json());
  geoEstados = await fetch("data/estados.geojson").then(r=>r.json());
  geoMunicipios = await fetch("data/municipios.geojson").then(r=>r.json());

  // TESTE VISUAL IMEDIATO
  L.geoJSON(geoRegioes,{style:{color:"red"}}).addTo(map);
  setTimeout(()=>{
    map.eachLayer(l=>{
      if(l instanceof L.GeoJSON) map.removeLayer(l);
    });
    mostrarRegioes();
  },1000);
}

voltar.onclick=()=>{ if(pilha.length) pilha.pop()(); };

iniciar();
</script>
</body>
</html>
